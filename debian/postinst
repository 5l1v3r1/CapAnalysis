#!/bin/sh

set -e

case "$1" in
    configure)
        
        if [ -f /opt/capanalysis/cfg/canalysis.cfg.backup ]; then
            # upgrade DB
            mv /opt/capanalysis/cfg/canalysis.cfg /opt/capanalysis/cfg/canalysis.cfg.last
            cp /opt/capanalysis/cfg/canalysis.cfg.backup /opt/capanalysis/cfg/canalysis.cfg
        fi
    
        chown -R www-data:www-data /opt/capanalysis
        if [ -f /etc/php5/apache2/php.ini ]; then
            sed -i 's/post_max_size.*/post_max_size = 500M/g' /etc/php5/apache2/php.ini
            sed -i 's/upload_max_filesize.*/upload_max_filesize = 500M/g' /etc/php5/apache2/php.ini
            a2enmod php5
        fi
        if [ -f /etc/php/7.0/apache2/php.ini ]; then
            sed -i 's/post_max_size.*/post_max_size = 500M/g' /etc/php/7.0/apache2/php.ini
            sed -i 's/upload_max_filesize.*/upload_max_filesize = 500M/g' /etc/php/7.0/apache2/php.ini
            a2enmod php7.0
            a2dismod mpm_event
            a2enmod mpm_prefork
        fi
        if [ -f /etc/apache2/sites-available/capana.conf ]; then
            ln -s /etc/apache2/sites-available/capana.conf /etc/apache2/sites-enabled/098-capana.conf
        fi

        a2enmod rewrite
        
        apache2ctl restart
        
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
